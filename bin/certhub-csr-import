#!/bin/sh

set -e
set -u

# Required binaries
BASENAME=/usr/bin/basename
ECHO=/bin/echo
MKDIR=/bin/mkdir
MV=/bin/mv
OPENSSL=/usr/bin/openssl
XARGS=/usr/bin/xargs

# Print usage message and exit.
usage() {
    ${ECHO} "${0}: /path/to/certhub/instance.example.com csr.pem [ssl.cnf]"
    return 1
}

certhub_csr_import() {
    INSTANCE_DIR="${1}"
    INSTANCE_NAME_DEFAULT=$(${BASENAME} "${INSTANCE_DIR}")
    CSR_PATH="${INSTANCE_DIR}/${CERTHUB_CSR_NAME:-csr.pem}"
    CNF_PATH="${INSTANCE_DIR}/${CERTHUB_CNF_NAME:-ssl.cnf}"
    REQ_LOGOPTS="${CERTHUB_REQ_LOGOPTS:--noout -text -reqopt no_pubkey,no_sigdump}"

    ${ECHO} "[Certhub] CSR import ${CERTHUB_INSTANCE_NAME:-${INSTANCE_NAME_DEFAULT}}"
    ${ECHO}

    if [ ! -e "${INSTANCE_DIR}" ]; then
        ${MKDIR} "${INSTANCE_DIR}"
    fi

    ${MV} "${2}" "${CSR_PATH}"

    if [ -n "${3}" ]; then
        ${MV} "${3}" "${CNF_PATH}"
    fi

    if [ -n "${REQ_LOGOPTS}" ]; then
        ${ECHO} "${REQ_LOGOPTS}" | ${XARGS} ${OPENSSL} req -in "${CSR_PATH}"
        ${ECHO}
    fi
}

if [ "${#}" -gt 1 ] && [ "${1:-}" != "-h" ] && [ "${1:-}" != "--help" ]; then
    certhub_csr_import "${@}"
else
    usage
fi
